<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Uncommon Hacks 2017</title>
    <link rel="stylesheet" type="text/css" href="main.css">
    <script src="jquery-3.1.1.js"></script>
    <script>
        function initMap(){
            /*function geolocate() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(position) {
                    var geolocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                    };
                    var circle = new google.maps.Circle({
                    center: geolocation,
                    radius: position.coords.accuracy
                    });
                    autocomplete.setBounds(circle.getBounds());
                });
                }
            }*/
            var SPEED = 100;
            var RED = 100;
            var chicago = {lat: 41.8333925, lng: -88.0123333};
            var map = new google.maps.Map(document.getElementById("map"),{
                zoom:10,
                center:chicago
                });
            
            var speedcams = [];
            var redcams = [];
            //creates speed camera markers
            $.getJSON("data/speed-cam-locations.json", function(json){
                var locs = json.data;
                for(var i=0;i<locs.length;i++){
                    var pos = {lat:parseFloat(locs[i][12]), lng:parseFloat(locs[i][13])};
                    var marker = new google.maps.Marker({
                        position:pos,
                        title:"Speed Camera"
                    });
                    speedcams.push(marker);
                }
            });
            //created red light camera markers
            $.getJSON("data/red-cam-location.json", function(json){
                var locs = json.data;
                for(var i=0;i<locs.length;i++){
                    var pos = {lat:parseFloat(locs[i][13]), lng:parseFloat(locs[i][14])};
                    var marker = new google.maps.Marker({
                        position:pos,
                        icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
                        title:"Red Light Camera"
                    });
                    redcams.push(marker);
                }
            });

            //handling autocomplete
            var from = new google.maps.places.Autocomplete(document.getElementById("start-location"));
            var to = new google.maps.places.Autocomplete(document.getElementById("end-location"));
            var from_marker = new google.maps.Marker({
                title:"Origin"
            });
            var to_marker = new google.maps.Marker({
                title:"Destination"
                });
            var pathv = [from_marker, to_marker];
            var origin;
            var destination;

            from.bindTo("bounds", map);
            to.bindTo("bounds", map);
            from.setOptions({strictBounds: true});
            to.setOptions({strictBounds: true});            
            
            var directionsService = new google.maps.DirectionsService;
            var directionsDisplay = new google.maps.DirectionsRenderer({
                draggable: true,
                map: map,
                panel: document.getElementById('right-panel')
            });

            var directionsService = new google.maps.DirectionsService;
            var directionsDisplay = new google.maps.DirectionsRenderer({
                draggable: true,
                map: map,
                panel: document.getElementById('right-panel')
            });

            directionsDisplay.addListener('directions_changed', function() {
                computeTotalDistance(directionsDisplay.getDirections());
            });   
            function displayRoute(origin, destination, service, display) {
                service.route({
                origin: origin,
                destination: destination,
                waypoints: [],
                travelMode: 'DRIVING',
                avoidTolls: true
                }, function(response, status) {
                if (status === 'OK') {
                    display.setDirections(response);
                } else {
                    alert('Could not display directions due to: ' + status);
                }
                });
            }; 
            function computeTotalDistance(result) {
                var total = 0;
                var myroute = result.routes[0];
                var totalDuration = 0;
                var speed = 0;
                var time10 = 0;
                var time25 = 0;

                for (var i = 0; i < myroute.legs.length; i++) {
                    total += myroute.legs[i].distance.value;
                    totalDuration += myroute.legs[i].duration.value;
                }

                total = total*0.000621371
                speed = total/(totalDuration/3600)
                time10 = total/((speed+10)/60)
                time25 = total/((speed+25)/60)

                $("#trip-distance").text(Math.round(total*100)/100);
                $("#trip-time").text(Math.round(totalDuration/60));
                $("#trip-time10").text(Math.round(time10));
                $("#trip-time25").text(Math.round(time25));
                //document.getElementById('total').innerHTML = total + ' km';

                pathRoute = result.routes[0].overview_path;

                var speed_tickets = checkCameras(speedcams,pathRoute,"speed");
                var red_tickets = checkCameras(redcams,pathRoute,"red light")
                $("#speed-traps").text(speed_tickets);
                $("#red-lights").text(red_tickets);
                var fine = speed_tickets * SPEED + red_tickets * RED;
                $("#total").text(fine);

            }
            function checkCameras(cameraArray, pathRoute, cameraType) {
                polylineRoute = new google.maps.Polyline({path: pathRoute});
                camerasPassed = 0;
                cameraArray.forEach(function(cam){
                    cam.setMap(null);
                    if (checkIfOnEdge(cam.position, polylineRoute)){
                        camerasPassed++;
                        cam.setMap(map);
                    }
                    /*else{
                        cam.setIcon("http://maps.google.com/mapfiles/ms/icons/green-dot.png");
                        cam.setMap(map);
                    }*/
                })
                return camerasPassed;  
                              
            }
            function checkIfOnEdge(cam, polylineRoute) {
                isOnEdge = google.maps.geometry.poly.isLocationOnEdge(cam, polylineRoute, 0.001)
                return isOnEdge
            }; 
            from.addListener('place_changed', function(){
                var place = from.getPlace();
                //clears out the start point
                from_marker.setMap(null);

                from_marker.setPosition(place.geometry.location);
                from_marker.setMap(map);
            });
            to.addListener('place_changed', function(){
                var place = to.getPlace();
                //clears out the start point
                to_marker.setMap(null);

                to_marker.setPosition(place.geometry.location);
                to_marker.setMap(map);
            });
            $("#myAnimation").on("click", function(){
                if(!(from.getPlace() && to.getPlace())){
                    alert("Plese provide both the from and to path");
                }
                else{
                    displayRoute(from.getPlace().geometry.location, 
                                 to.getPlace().geometry.location,
                                 directionsService,
                                 directionsDisplay)
                }
            });
            
        }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA2I74gM_d-BKNFw3mat6ziCeedygNfzic&libraries=places&callback=initMap"
         async defer></script>

</head>
<body>
    <h1>math.<b>floor(it)</b></h1>
    <br/>
    <div class="location-inputs">
      <form-group>
        <label for="start-location">Start Point</label>
        <input id="start-location" type="text" placeholder="Start...">
        <!--input id="start-location" type="text" placeholder="Start..." onFocus="geolocate()"-->
      </form-group>
      <form-group>
        <label for="end-location">End Point</label>
        <input id="end-location" type="text" placeholder="End...">
      </form-group>


      <form-group id ="myContainer">
        <div id ="myAnimation" onclick="myMove()">
          <img id="pic" src="car2.jpg" height=30px width=auto />
        </div>
        <script>
          function myMove() {
            var elem = document.getElementById("myAnimation");
            var pos = 0;
            var id = setInterval(frame, 10);
            function frame() {
             if (pos == 300) {
               clearInterval(id);
               elem.style.left = "0px";
              } else {
                pos++; 
                elem.style.left = pos + 'px'; 
              }
            }
          }
        </script>

      <!--<input id="car-animation" type="image" src="car1.jpg">-->
      <!--<input id="car-animation" type="button">-->
      <!--<button id="car-animation"><img src="car1.jpg"></button>
      <button id="animate-car" onclick="animateImage()"></button>
      <script language="javascript">
        function animateImage() {
          document.getElementById("animate-car").src == "car2.jpg") 
        }
      </script>-->

      </form-group>
    </div>
    <div id="map"></div>
    <div id="summary">
        <p style="font-size:160%;">Trip Information</p>
        <p>Total Distance: <span id="trip-distance">0</span> miles</p>
        <p style="font-size:120%;">Total Time:</p>
        <p>without speeding: <span id="trip-time">0</span> minutes</p>
        <p>speeding 10 miles over: <span id="trip-time10">0</span> minutes</p>
        <p>speeding 25 miles over: <span id="trip-time25">0</span> minutes</p>
        <p>You could speed through <span id="red-lights">0</span> red light camera(s).</p>
        <p>You could speed past <span id="speed-traps">0</span> speed camera(s).</p>
        <p>You could owe $<span id="total">0</span> from driving so recklessly.</p>
    </div>
</body>
</html>